INSERT INTO FSO_tb_p_DedcutNotReturnDetail(DNRId,IsInput,SalesId,DeductType,DeductAmount,CreateOn,CreateBy)
            SELECT DNRId,1,C.SignerId,
            CASE WHEN SC.ContLevel IN(1,3,8) THEN 
            CASE WHEN (CASE WHEN ISNULL(D.ProAmount,0)=0 THEN A.BaseAmount ELSE D.ProAmount END)>1000000 AND (SELECT COUNT(*) FROM FSO_TB_P_DEDCUTNOTRETURN AC WHERE AC.MContractNo=A.MContractNo AND A.PId IN (SELECT TOP 4 PID FROM #TEMP_PID))<4  THEN 0
            ELSE 1 END
            ELSE CASE WHEN (SELECT COUNT(*) FROM FSO_TB_P_DEDCUTNOTRETURN AC WHERE AC.MContractNo=A.MContractNo AND A.PId IN (SELECT TOP 4 PID FROM #TEMP_PID))=4 THEN 1 
            ELSE 0 END END DeductType,
            CASE WHEN A.BaseAmount<500000 THEN 500 WHEN 500000<=A.BaseAmount AND A.BaseAmount<1000000 THEN 1000 WHEN 1000000<=A.BaseAmount AND A.BaseAmount<5000000 THEN 2000 ELSE 5000 END DeductAmount ,GETDATE(),'{1}' 
            FROM FSO_TB_P_DEDCUTNOTRETURN A
            LEFT JOIN (SELECT CONTRACTNO,SignerId FROM #TEMP_BASEAMOUNT GROUP BY CONTRACTNO,SignerId) C ON A.MContractNo=C.CONTRACTNO
            LEFT JOIN FSO_tb_e_SalesContract SC ON SC.ContractNo=A.MContractNo
            left join (select sum(CASE WHEN ISNULL(C.TotalAmount,0)>0 THEN TotalAmount ELSE ProAmount END)  ProAmount,CASE WHEN ISNULL(SC.MainContractNo,'')='' THEN SC.ContractNo ELSE SC.MainContractNo END CONTRACTNO 
                        from FSO_tb_e_SalesContract SC
                        LEFT JOIN FSO_tb_e_AgreeRelateContract B ON SC.ContractId=B.ContractId
                        LEFT JOIN FSO_tb_e_SalesAgreeContract C ON B.SalesAgreeId=C.Id
                        GROUP BY CASE WHEN ISNULL(SC.MainContractNo,'')='' THEN SC.ContractNo ELSE SC.MainContractNo END) D ON A.MContractNo=D.ContractNo
            WHERE A.PId='{0}'
